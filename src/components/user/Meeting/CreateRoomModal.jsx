import React, { useState, useCallback } from "react";
import {
  Button,
  Input,
  Form,
  Card,
  message,
  Modal,
  DatePicker,
  Select,
} from "antd";
import { User, Users, Calendar, Link, Clock, FileText } from "lucide-react";
import { useSelector } from "react-redux";
import apiService from "../../../services/apiService";
import { authSelector } from "../../../reduxs/reducers/AuthReducer";

const CreateRoomModal = ({ visible, onCancel, onRoomCreated }) => {
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  const [createdRoom, setCreatedRoom] = useState(null);

  // L·∫•y auth data t·ª´ Redux store
  const authData = useSelector(authSelector);

  // L·∫•y th√¥ng tin user t·ª´ localStorage ho·∫∑c Redux store
  const getCurrentUser = useCallback(() => {
    try {
      console.log("üîç getCurrentUser called");

      // Ki·ªÉm tra t·∫•t c·∫£ keys c√≥ th·ªÉ c√≥ trong localStorage
      const possibleKeys = [
        "authData",
        "auth",
        "user",
        "userData",
        "loginData",
      ];

      for (const key of possibleKeys) {
        const data = localStorage.getItem(key);
        if (data) {
          console.log(`üì¶ Found data in localStorage key "${key}":`, data);
          try {
            const parsed = JSON.parse(data);
            console.log(`üì¶ Parsed data from "${key}":`, parsed);

            // Th·ª≠ l·∫•y user ID t·ª´ nhi·ªÅu tr∆∞·ªùng c√≥ th·ªÉ
            const userId =
              parsed._id ||
              parsed.id ||
              parsed.user_id ||
              parsed.user?.id ||
              parsed.user?._id ||
              parsed.user?.user_id ||
              parsed.data?._id ||
              parsed.data?.id ||
              parsed.data?.user_id;

            if (userId) {
              console.log(`‚úÖ Found userId "${userId}" in key "${key}"`);

              const userInfo = {
                id: userId,
                username:
                  parsed.username ||
                  parsed.user?.username ||
                  parsed.data?.username,
                fullName:
                  parsed.fullName ||
                  parsed.full_name ||
                  parsed.user?.fullName ||
                  parsed.user?.full_name ||
                  parsed.data?.fullName ||
                  parsed.data?.full_name,
                email: parsed.email || parsed.user?.email || parsed.data?.email,
                token:
                  parsed.token ||
                  parsed.access_token ||
                  parsed.accessToken ||
                  parsed.user?.token ||
                  parsed.data?.token,
              };

              console.log(
                `‚úÖ Final userInfo from localStorage "${key}":`,
                userInfo
              );
              return userInfo;
            }
          } catch (parseError) {
            console.warn(`‚ö†Ô∏è Failed to parse data from "${key}":`, parseError);
          }
        }
      }

      // Fallback: l·∫•y t·ª´ Redux store
      console.log("üîÑ Checking Redux authData:", authData);
      if (authData && (authData._id || authData.id)) {
        const userInfo = {
          id: authData._id || authData.id,
          username: authData.username,
          fullName:
            authData.fullName || authData.full_name || authData.username,
          email: authData.email,
          token: authData.token,
        };

        console.log("‚úÖ Final userInfo from Redux:", userInfo);
        return userInfo;
      }

      console.log("‚ùå No valid user data found anywhere");
      return null;
    } catch (error) {
      console.error("‚ùå Error in getCurrentUser:", error);
      return null;
    }
  }, [authData]);

  // Auto-fill form khi modal m·ªü
  React.useEffect(() => {
    if (visible) {
      // Debug: Ki·ªÉm tra t·∫•t c·∫£ auth states
      console.log("=== AUTH DEBUG ===");
      console.log("Redux authData:", authData);
      console.log("localStorage authData:", localStorage.getItem("authData"));
      console.log("localStorage keys:", Object.keys(localStorage));

      const currentUser = getCurrentUser();
      console.log("getCurrentUser result:", currentUser);

      if (currentUser) {
        console.log("‚úÖ User found, setting form defaults");
        // Ch·ªâ set gi√° tr·ªã m·∫∑c ƒë·ªãnh cho form, kh√¥ng hi·ªÉn th·ªã c√°c field ·∫©n
        form.setFieldsValue({
          roomName: "",
          startTime: null,
          meetingPassword: "",
          notes: "",
        });
      } else {
        console.log("‚ùå No user found");
        message.warning("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o ph√≤ng!");
      }
    }
  }, [visible, form, getCurrentUser, authData]);

  const handleSubmit = async (values) => {
    setLoading(true);
    try {
      const currentUser = getCurrentUser();
      console.log("Current user for room creation:", currentUser);

      if (!currentUser) {
        message.error("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o ph√≤ng!");
        return;
      }

      if (!currentUser.id) {
        message.error(
          "Kh√¥ng th·ªÉ l·∫•y th√¥ng tin user ID. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!"
        );
        console.error("User ID is missing:", currentUser);
        return;
      }

      // X·ª≠ l√Ω logic th·ªùi gian
      const now = new Date();
      let startTime, endTime, status;

      if (values.startTime) {
        // N·∫øu c√≥ th·ªùi gian b·∫Øt ƒë·∫ßu -> l√™n l·ªãch
        startTime = new Date(values.startTime);
        endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // +1 hour
        status = "scheduled";
      } else {
        // N·∫øu kh√¥ng c√≥ th·ªùi gian -> b·∫Øt ƒë·∫ßu ngay
        startTime = now;
        endTime = new Date(now.getTime() + 60 * 60 * 1000); // +1 hour
        status = "ongoing";
      }

      // T·∫°o room data v·ªõi th√¥ng tin user t·ª´ localStorage
      const roomData = {
        room_name: values.roomName || "Ph√≤ng h·ªçc m·ªõi",
        mentor_id: parseInt(currentUser.id), // ƒê·∫£m b·∫£o l√† s·ªë
        user_id: parseInt(currentUser.id), // ƒê·∫£m b·∫£o l√† s·ªë
        start_time: startTime.toISOString(),
        end_time: endTime.toISOString(),
        status: status,
        details: {
          meeting_link: null, // S·∫Ω ƒë∆∞·ª£c t·∫°o sau
          meeting_password: values.meetingPassword || null,
          notes: values.notes || null,
          recorded_url: null,
        },
        participants: [],
        creator_name: currentUser.fullName || currentUser.username,
      };

      console.log("Creating room with data:", roomData);

      const response = await apiService.createMeetingRoom(roomData);
      console.log("Room created response:", response);

      // Extract room data from response
      const roomResult = response.data?.room || response.data || response;

      setCreatedRoom(roomResult);

      // Th√¥ng b√°o d·ª±a tr√™n tr·∫°ng th√°i
      if (roomResult.status === "scheduled") {
        message.success(
          `‚úÖ T·∫°o ph√≤ng th√†nh c√¥ng! Ph√≤ng ƒë√£ ƒë∆∞·ª£c l√™n l·ªãch v√†o l√∫c ${new Date(
            roomResult.start_time
          ).toLocaleString("vi-VN")}`
        );
      } else {
        message.success(
          "‚úÖ T·∫°o ph√≤ng th√†nh c√¥ng! Ph√≤ng ƒëang s·∫µn s√†ng cho cu·ªôc h·ªçc."
        );
      }

      // T·∫°o meeting link ƒë·ªÉ redirect
      const userForRedirect = getCurrentUser();
      const redirectLink = `${window.location.origin}/meeting/${
        roomResult.id
      }?userName=${encodeURIComponent(
        userForRedirect?.fullName || userForRedirect?.username || "Anonymous"
      )}`;

      if (onRoomCreated) {
        onRoomCreated({
          ...roomResult,
          meetingLink: redirectLink,
          userName:
            userForRedirect?.fullName ||
            userForRedirect?.username ||
            "Anonymous",
        });
      }

      form.resetFields();
    } catch (error) {
      console.error("Error creating room:", error);
      message.error(`L·ªói t·∫°o ph√≤ng: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const copyMeetingLink = () => {
    if (createdRoom) {
      const userForCopy = getCurrentUser();
      const userName =
        userForCopy?.fullName || userForCopy?.username || "Anonymous";
      const copyLink = `${window.location.origin}/meeting/${
        createdRoom.id
      }?userName=${encodeURIComponent(userName)}`;
      navigator.clipboard.writeText(copyLink);
      message.success("ƒê√£ copy link ph√≤ng h·ªçc!");
    }
  };

  return (
    <Modal
      title="ÔøΩ T·∫°o Ph√≤ng H·ªçc M·ªõi"
      open={visible}
      onCancel={onCancel}
      footer={null}
      width={500}
    >
      <Form form={form} layout="vertical" onFinish={handleSubmit}>
        <Form.Item
          name="roomName"
          label="T√™n ph√≤ng h·ªçc"
          rules={[{ required: true, message: "Vui l√≤ng nh·∫≠p t√™n ph√≤ng!" }]}
        >
          <Input
            prefix={<Users size={16} />}
            placeholder="Nh·∫≠p t√™n ph√≤ng h·ªçc"
            size="large"
          />
        </Form.Item>

        <Form.Item
          name="startTime"
          label="Th·ªùi gian b·∫Øt ƒë·∫ßu (B·ªè tr·ªëng ƒë·ªÉ b·∫Øt ƒë·∫ßu ngay)"
        >
          <DatePicker
            showTime
            placeholder="Ch·ªçn th·ªùi gian b·∫Øt ƒë·∫ßu"
            size="large"
            style={{ width: "100%" }}
            format="DD/MM/YYYY HH:mm"
            disabledDate={(current) =>
              current && current < new Date().setHours(0, 0, 0, 0)
            }
          />
        </Form.Item>

        <Form.Item name="meetingPassword" label="M·∫≠t kh·∫©u ph√≤ng (t√πy ch·ªçn)">
          <Input.Password
            placeholder="Nh·∫≠p m·∫≠t kh·∫©u b·∫£o v·ªá ph√≤ng"
            size="large"
          />
        </Form.Item>

        <Form.Item name="notes" label="Ghi ch√∫ (t√πy ch·ªçn)">
          <Input.TextArea
            rows={3}
            placeholder="Th√™m ghi ch√∫ v·ªÅ cu·ªôc h·ªçc..."
            size="large"
          />
        </Form.Item>

        {createdRoom && (
          <Card
            size="small"
            title="‚úÖ Ph√≤ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!"
            style={{
              marginBottom: 16,
              backgroundColor: "#f6ffed",
              borderColor: "#b7eb8f",
            }}
          >
            <div
              style={{ display: "flex", flexDirection: "column", gap: "8px" }}
            >
              <p>
                <strong>üìù T√™n ph√≤ng:</strong> {createdRoom.room_name}
              </p>
              <p>
                <strong>üÜî Room ID:</strong> {createdRoom.id}
              </p>
              <p>
                <strong>üìä Tr·∫°ng th√°i:</strong> {createdRoom.status}
              </p>
              {createdRoom.start_time && (
                <p>
                  <strong>‚è∞ B·∫Øt ƒë·∫ßu:</strong>{" "}
                  {new Date(createdRoom.start_time).toLocaleString("vi-VN")}
                </p>
              )}
              {createdRoom.end_time && (
                <p>
                  <strong>‚è∞ K·∫øt th√∫c:</strong>{" "}
                  {new Date(createdRoom.end_time).toLocaleString("vi-VN")}
                </p>
              )}
              {createdRoom.meetingroomdetails?.[0]?.meeting_password && (
                <p>
                  <strong>üîí M·∫≠t kh·∫©u:</strong>{" "}
                  {createdRoom.meetingroomdetails[0].meeting_password}
                </p>
              )}
              {createdRoom.meetingroomdetails?.[0]?.notes && (
                <div>
                  <strong>üìÑ Ghi ch√∫:</strong>
                  <div
                    style={{
                      marginTop: "4px",
                      padding: "8px",
                      backgroundColor: "#f9f9f9",
                      borderRadius: "4px",
                    }}
                  >
                    {createdRoom.meetingroomdetails[0].notes}
                  </div>
                </div>
              )}
            </div>

            <div style={{ marginTop: 16 }}>
              <Button
                type="primary"
                icon={<Link size={16} />}
                onClick={copyMeetingLink}
                block
              >
                üìã Copy Link Meeting
              </Button>
            </div>
          </Card>
        )}

        <div style={{ textAlign: "center", marginTop: "20px" }}>
          <Button
            type="primary"
            htmlType="submit"
            loading={loading}
            size="large"
            style={{
              background: "linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)",
              border: "none",
              borderRadius: "25px",
              padding: "0 40px",
              height: "45px",
            }}
          >
            {loading ? "ƒêang t·∫°o ph√≤ng..." : "üöÄ T·∫°o Ph√≤ng H·ªçc"}
          </Button>
        </div>
      </Form>
    </Modal>
  );
};

export default CreateRoomModal;
